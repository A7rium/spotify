<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Web Playback SDK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #1c1c1c;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: flex-end;
        }

        #visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 100px); /* Adjust the height to accommodate the player */
            z-index: 1;
        }

        #player {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            background-color: #2c2c2c;
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            max-width: 100%;
            width: 100%;
            margin-top: auto;
        }

        #player-info {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }

        #album-art {
            width: 60px;
            height: 60px;
            margin-right: 15px;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        #track-info h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #ffffff;
        }

        #controls {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }

        #controls button {
            background-color: #404040;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            width: 40px;
            height: 40px;
            margin: 0 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #controls button:hover {
            background-color: #1db954;
        }

        #volume-control {
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        #volume-control i {
            margin-right: 10px;
        }

        #catalog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            overflow-y: auto;
            background-color: #2c2c2c;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            padding: 20px;
            z-index: 1000;
            display: none;
        }

        #catalog.hidden {
            display: none;
        }

        #catalog ul {
            display: flex;
            flex-wrap: wrap;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #catalog li {
            flex: 1 1 calc(25% - 20px);
            display: flex;
            align-items: center;
            margin: 10px;
            cursor: pointer;
        }

        #catalog li img {
            width: 70px;
            height: 70px;
            border-radius: 5px;
            margin-right: 15px;
        }

        #catalog li h4 {
            margin: 0;
            font-size: 1.2rem;
            color: #ffffff;
        }

        #catalog li p {
            margin: 5px 0 0;
            font-size: 1rem;
            color: #aaaaaa;
        }

        /* Add the Press ESC to close hint */
        #catalog::after {
            content: "Press ESC to close";
            position: fixed;
            bottom: 10px;
            right: 20px;
            color: #ffffff;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <canvas id="visualizer"></canvas>

    <div id="player">
        <div id="player-info">
            <img id="album-art" src="https://upload.wikimedia.org/wikipedia/commons/2/26/Spotify_logo_with_text.svg" alt="Spotify Logo" class="logo">
            <div id="track-info">
                <h3 id="track-title">Spotify Player by RT8MG</h3>
            </div>
        </div>
        <div id="controls">
            <button id="prev"><i class="fas fa-backward"></i></button>
            <button id="play-pause"><i class="fas fa-play"></i></button>
            <button id="next"><i class="fas fa-forward"></i></button>
            <button id="catalog-menu"><i class="fas fa-list"></i></button>
        </div>
        <div id="volume-control">
            <i class="fas fa-volume-down"></i>
            <input type="range" id="volume" min="0" max="100" value="50" class="slider">
        </div>
    </div>

    <div id="catalog" class="hidden">
        <ul id="catalog-list"></ul>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/butterchurn@1.6.6/dist/butterchurn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/butterchurn-presets@1.7.0/dist/butterchurn-presets.min.js"></script>
    <script>
        const clientId = 'cdae67bfd8c542f0980cf22d8f30ec55'; // Your Spotify Client ID
        const redirectUri = 'https://a7rium.github.io/spotify/'; // Your GitHub Pages URL
        const scopes = [
            'streaming',
            'user-read-email',
            'user-read-private',
            'user-modify-playback-state',
            'user-read-playback-state',
            'playlist-read-private',
            'playlist-modify-public',
            'playlist-modify-private'
        ];

        const authEndpoint = 'https://accounts.spotify.com/authorize';

        const hash = window.location.hash
            .substring(1)
            .split('&')
            .reduce((initial, item) => {
                if (item) {
                    const parts = item.split('=');
                    initial[parts[0]] = decodeURIComponent(parts[1]);
                }
                return initial;
            }, {});

        window.location.hash = '';

        let _token = hash.access_token;

        if (!_token) {
            window.location = `${authEndpoint}?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${scopes.join(
                '%20'
            )}&response_type=token&show_dialog=true`;
        } else {
            initSpotifyPlayer(_token);
        }

        function initSpotifyPlayer(token) {
            window.onSpotifyWebPlaybackSDKReady = () => {
                const player = new Spotify.Player({
                    name: 'Spotify Player by RT8MG',
                    getOAuthToken: cb => { cb(token); },
                    volume: 0.5
                });

                player.addListener('initialization_error', ({ message }) => { console.error(message); });
                player.addListener('authentication_error', ({ message }) => { console.error(message); });
                player.addListener('account_error', ({ message }) => { console.error(message); });
                player.addListener('playback_error', ({ message }) => { console.error(message); });

                player.addListener('player_state_changed', state => {
                    if (state) {
                        const trackName = state.track_window.current_track.name;
                        const albumArt = state.track_window.current_track.album.images[0]?.url;

                        document.getElementById('track-title').textContent = trackName || "Spotify Player by RT8MG";
                        const albumArtElement = document.getElementById('album-art');
                        if (albumArt) {
                            albumArtElement.src = albumArt;
                        } else {
                            albumArtElement.src = 'https://upload.wikimedia.org/wikipedia/commons/2/26/Spotify_logo_with_text.svg';
                        }

                        const playPauseButton = document.getElementById('play-pause');
                        playPauseButton.innerHTML = state.paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';

                        if (state.paused) {
                            albumArtElement.classList.remove('playing');
                        } else {
                            albumArtElement.classList.add('playing');
                        }
                    }
                });

                player.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    playDefaultPlaylist(device_id, token);
                    loadPlaylistCatalog(token);
                });

                player.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                });

                player.connect();

                document.getElementById('play-pause').addEventListener('click', () => {
                    player.togglePlay();
                });

                document.getElementById('next').addEventListener('click', () => {
                    player.nextTrack();
                });

                document.getElementById('prev').addEventListener('click', () => {
                    player.previousTrack();
                });

                document.getElementById('catalog-menu').addEventListener('click', () => {
                    document.getElementById('catalog').classList.remove('hidden');
                });

                document.addEventListener('keydown', function(event) {
                    if (event.key === "Escape") {
                        document.getElementById('catalog').classList.add('hidden');
                    }
                });

                document.getElementById('catalog').addEventListener('click', function(event) {
                    if (event.target === document.getElementById('catalog')) {
                        document.getElementById('catalog').classList.add('hidden');
                    }
                });

                const canvas = document.getElementById('visualizer');
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const visualizer = butterchurn.createVisualizer(audioContext, canvas, {
                    width: window.innerWidth,
                    height: window.innerHeight - document.getElementById('player').offsetHeight
                });

                const presets = butterchurnPresets.getPresets();
                const preset = presets['Flexi, martin + geiss - dedicated to the sherwin maxawow'];
                visualizer.loadPreset(preset, 0.0);

                window.addEventListener('resize', () => {
                    visualizer.setRendererSize(window.innerWidth, window.innerHeight - document.getElementById('player').offsetHeight);
                });

                const audioNode = audioContext.createMediaElementSource(new Audio());
                visualizer.connectAudio(audioNode);

                function renderVisualizer() {
                    visualizer.render();
                    requestAnimationFrame(renderVisualizer);
                }

                renderVisualizer();
            };
        }

        function playDefaultPlaylist(device_id, token) {
            const playlistUri = 'spotify:playlist:7uMdU7HvGCIy7IBEk8ZX4U';
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
                method: 'PUT',
                body: JSON.stringify({
                    context_uri: playlistUri
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            })
            .then(() => {
                console.log('Default playlist is playing.');
            })
            .catch(error => console.error('Error playing default playlist:', error));
        }

        function loadPlaylistCatalog(token) {
            const playlistId = '7uMdU7HvGCIy7IBEk8ZX4U';
            fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const catalogList = document.getElementById('catalog-list');
                catalogList.innerHTML = '';
                data.items.forEach(item => {
                    const track = item.track;
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <img src="${track.album.images[0].url}" alt="Album Art">
                        <div>
                            <h4>${track.name}</h4>
                            <p>${track.artists.map(artist => artist.name).join(', ')}</p>
                        </div>
                    `;
                    listItem.onclick = () => playSpecificTrack(track.uri, token);
                    catalogList.appendChild(listItem);
                });
            })
            .catch(error => console.error('Error loading playlist catalog:', error));
        }

        function playSpecificTrack(trackUri, token) {
            fetch(`https://api.spotify.com/v1/me/player/play`, {
                method: 'PUT',
                body: JSON.stringify({ uris: [trackUri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            }).catch(error => console.error('Error playing specific track:', error));
        }
    </script>
</body>
</html>
